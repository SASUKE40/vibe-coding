name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          echo "Diff size: $(wc -l < pr_diff.txt) lines"

      - name: Review with Claude
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff
          DIFF=$(cat pr_diff.txt)

          # Get PR title and body
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Create the review prompt
          PROMPT=$(cat <<'EOF'
          You are an expert code reviewer. Review the following pull request changes and provide constructive feedback.

          Focus on:
          - Code quality and best practices
          - Potential bugs or issues
          - Security concerns
          - Performance implications
          - TypeScript type safety
          - React/TanStack patterns

          Be concise and actionable. If the code looks good, say so briefly.
          Format your response in markdown suitable for a GitHub PR comment.
          Start with a brief summary, then list specific findings if any.
          EOF
          )

          # Build the request payload
          REQUEST_BODY=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            --arg diff "$DIFF" \
            '{
              model: "claude-sonnet-4-20250514",
              max_tokens: 4096,
              messages: [{
                role: "user",
                content: ($prompt + "\n\n## PR Title\n" + $title + "\n\n## PR Description\n" + $body + "\n\n## Changes\n```diff\n" + $diff + "\n```")
              }]
            }')

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$REQUEST_BODY")

          # Extract the review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not generate review"')

          # Save review to file for the next step
          echo "$REVIEW" > review.md

      - name: Post review comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW=$(cat review.md)

          # Add header to the review
          COMMENT="## ðŸ¤– Claude Code Review

          $REVIEW

          ---
          *This review was automatically generated by Claude.*"

          # Post the comment
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
